@page "/history"
@inject AppDbContext DbContext
@inject IJSRuntime JSRuntime
@using PomodoroFocus.Components.Shared

@implements IAsyncDisposable

<div class="min-h-screen bg-gradient-to-br dark:from-gray-900 dark:to-gray-800 py-8 px-4">
    <div class="max-w-7xl mx-auto">
        <!-- 页面标题 -->
        <div class="text-center mb-10">
            <h1 class="text-4xl font-bold text-gray-800 dark:text-white mb-2">历史记录</h1>
            <p class="text-gray-600 dark:text-gray-300">查看和分析你的番茄钟活动</p>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl overflow-hidden">
            <!-- 筛选控制区域 -->
            <div class="bg-gradient-to-r from-blue-500 to-indigo-600 p-6">
                <div class="flex flex-wrap items-center justify-between gap-4">
                    <div>
                        <h2 class="text-2xl font-bold text-white">筛选记录</h2>
                        <p class="text-blue-100 mt-1">按时间范围查看活动</p>
                    </div>
                    
                    <!-- 视图切换按钮 -->
                    <div class="view-selector flex flex-wrap gap-2" role="group">
                        <button type="button" class="px-4 py-2 rounded-lg font-medium transition-all duration-200 hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-50 active:scale-95 transform hover:-translate-y-0.5 @(_currentViewMode == ViewMode.All ? "bg-white text-blue-600" : "bg-blue-600 text-white hover:bg-blue-700")" @onclick="() => ChangeViewAsync(ViewMode.All)">全部</button>
                        <button type="button" class="px-4 py-2 rounded-lg font-medium transition-all duration-200 hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-50 active:scale-95 transform hover:-translate-y-0.5 @(_currentViewMode == ViewMode.Day ? "bg-white text-blue-600" : "bg-blue-600 text-white hover:bg-blue-700")" @onclick="() => ChangeViewAsync(ViewMode.Day)">日视图</button>
                        <button type="button" class="px-4 py-2 rounded-lg font-medium transition-all duration-200 hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-50 active:scale-95 transform hover:-translate-y-0.5 @(_currentViewMode == ViewMode.Week ? "bg-white text-blue-600" : "bg-blue-600 text-white hover:bg-blue-700")" @onclick="() => ChangeViewAsync(ViewMode.Week)">周视图</button>
                        <button type="button" class="px-4 py-2 rounded-lg font-medium transition-all duration-200 hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-50 active:scale-95 transform hover:-translate-y-0.5 @(_currentViewMode == ViewMode.Month ? "bg-white text-blue-600" : "bg-blue-600 text-white hover:bg-blue-700")" @onclick="() => ChangeViewAsync(ViewMode.Month)">月视图</button>
                        <button type="button" class="px-4 py-2 rounded-lg font-medium transition-all duration-200 hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-50 active:scale-95 transform hover:-translate-y-0.5 @(_currentViewMode == ViewMode.Year ? "bg-white text-blue-600" : "bg-blue-600 text-white hover:bg-blue-700")" @onclick="() => ChangeViewAsync(ViewMode.Year)">年视图</button>
                    </div>
                </div>
            </div>
            
            <!-- 自定义时间范围筛选 -->
            <div class="p-6 bg-gray-50 dark:bg-gray-700/50 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">@_viewTitle</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 items-end">
                    <div>
                        <label for="startDate" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">开始时间</label>
                        <input id="startDate" type="datetime-local" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 hover:shadow-md" @bind="_startDate" />
                    </div>
                    <div>
                        <label for="endDate" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">结束时间</label>
                        <input id="endDate" type="datetime-local" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 hover:shadow-md" @bind="_endDate" />
                    </div>
                    <div>
                        <button class="w-full px-6 py-3 bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-0.5 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 active:scale-95" @onclick="ApplyCustomFilterAsync">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z" clip-rule="evenodd" />
                            </svg>
                            应用筛选
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 内容区域 -->
            <div class="p-6">
                @if (sessions == null || !sessions.Any())
                {
                    <div class="text-center py-12">
                        <div class="mx-auto w-24 h-24 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mb-6">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                        <p class="text-gray-600 dark:text-gray-400 text-lg">@message</p>
                    </div>
                }
                else
                {
                    <!-- 图表区域 -->
                    <div class="mb-10">
                        <div class="bg-white dark:bg-gray-700 rounded-xl shadow-md p-6 border border-gray-200 dark:border-gray-600">
                            <h4 class="text-xl font-semibold text-gray-900 dark:text-white mb-4 text-center">活动分类占比</h4>
                            <div class="flex justify-center">
                                <div class="w-full max-w-md h-80">
                                    <canvas id="historyPieChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 统计卡片 -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
                        <div class="bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-900/30 dark:to-indigo-900/30 rounded-xl p-6 shadow-md border border-blue-100 dark:border-blue-900/50">
                            <div class="flex items-center">
                                <div class="p-3 bg-blue-100 dark:bg-blue-800/50 rounded-lg mr-4">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600 dark:text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-blue-600 dark:text-blue-400">总专注时间</p>
                                    <p class="text-2xl font-bold text-gray-900 dark:text-white">@sessions.Sum(s => s.ActualWorkDurationMinutes) 分钟</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-green-50 to-emerald-50 dark:from-green-900/30 dark:to-emerald-900/30 rounded-xl p-6 shadow-md border border-green-100 dark:border-green-900/50">
                            <div class="flex items-center">
                                <div class="p-3 bg-green-100 dark:bg-green-800/50 rounded-lg mr-4">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600 dark:text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-green-600 dark:text-green-400">完成会话</p>
                                    <p class="text-2xl font-bold text-gray-900 dark:text-white">@sessions.Count 次</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-purple-50 to-violet-50 dark:from-purple-900/30 dark:to-violet-900/30 rounded-xl p-6 shadow-md border border-purple-100 dark:border-purple-900/50">
                            <div class="flex items-center">
                                <div class="p-3 bg-purple-100 dark:bg-purple-800/50 rounded-lg mr-4">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-purple-600 dark:text-purple-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" />
                                    </svg>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-purple-600 dark:text-purple-400">平均专注时长</p>
                                    <p class="text-2xl font-bold text-gray-900 dark:text-white">@(sessions.Any() ? Math.Round(sessions.Average(s => s.ActualWorkDurationMinutes), 1) : 0) 分钟</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 会话列表 -->
                    <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">会话记录</h3>
                    <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                        @foreach (var session in sessions.OrderByDescending(s => s.StartTime))
                        {
                            <div class="bg-white dark:bg-gray-700 rounded-xl shadow-md p-5 hover:shadow-lg transition-all duration-200 cursor-pointer transform hover:-translate-y-1 hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 border border-gray-200 dark:border-gray-600" @onclick="() => ShowConversationDetails(session)" tabindex="0">
                                <div class="flex justify-between items-start mb-3">
                                    <span class="px-3 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-300 text-sm font-medium rounded-full transition-colors duration-200">@session.ActivityCategory</span>
                                    <span class="text-sm text-gray-500 dark:text-gray-400 transition-colors duration-200">@session.StartTime.ToString("yyyy-MM-dd HH:mm")</span>
                                </div>
                                <div class="mb-4">
                                    <p class="text-gray-700 dark:text-gray-300 text-sm line-clamp-3 transition-colors duration-200">@session.LLMSummary</p>
                                </div>
                                <div class="pt-3 border-t border-gray-200 dark:border-gray-600 transition-colors duration-200">
                                    <div class="flex justify-between text-sm">
                                        <span class="text-gray-600 dark:text-gray-400 transition-colors duration-200">
                                            工作: <strong class="text-green-600 dark:text-green-400">@session.ActualWorkDurationMinutes</strong> 分钟
                                        </span>
                                        <span class="text-gray-600 dark:text-gray-400 transition-colors duration-200">
                                            休息: <strong class="text-blue-600 dark:text-blue-400">@session.ActualBreakDurationMinutes</strong> 分钟
                                        </span>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@if (_isHistoryModalVisible)
{
    <ConversationHistoryModal ConversationJson="@_selectedConversationJson"
                              OnClose="() => _isHistoryModalVisible = false" />
}

@code {
    // 定义视图模式 Enum
    private enum ViewMode { All, Day, Week, Month, Year, Custom }

    private List<PomodoroSession> sessions;
    private string message = "正在加载...";
    private const string ChartCanvasId = "historyPieChart";

    private DateTime? _startDate;
    private DateTime? _endDate;
    private ViewMode _currentViewMode;
    private string _viewTitle;
    private bool _isDataLoaded = false;

    private bool _isHistoryModalVisible = false;
    private string _selectedConversationJson;

    // 页面初始化时，默认设置为日视图
    protected override async Task OnInitializedAsync()
    {
        await ChangeViewAsync(ViewMode.Day);
        _isDataLoaded = true;
    }

    // 在UI渲染完成后绘制图表
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // 仅在首次加载或数据刷新后重新渲染图表
        if (firstRender && _isDataLoaded)
        {
            await RenderChartAsync();
        }
    }

    // 核心方法，用于切换预设视图
    private async Task ChangeViewAsync(ViewMode newMode)
    {
        _currentViewMode = newMode;
        var now = DateTime.Now;

        switch (newMode)
        {
            case ViewMode.All:
                _startDate = null;
                _endDate = null;
                _viewTitle = "所有记录";
                break;
            case ViewMode.Day:
                _startDate = now.Date;
                _endDate = _startDate.Value.AddDays(1).AddTicks(-1);
                _viewTitle = $"今天 ({now:yyyy-MM-dd})";
                break;
            case ViewMode.Week:
                int diff = (7 + (int)now.DayOfWeek - (int)DayOfWeek.Monday) % 7;
                _startDate = now.AddDays(-1 * diff).Date;
                _endDate = _startDate.Value.AddDays(7).AddTicks(-1);
                _viewTitle = $"本周 ({_startDate:MM-dd} - {_endDate:MM-dd})";
                break;
            case ViewMode.Month:
                _startDate = new DateTime(now.Year, now.Month, 1);
                _endDate = _startDate.Value.AddMonths(1).AddTicks(-1);
                _viewTitle = $"{now:yyyy年MMMM}";
                break;
            case ViewMode.Year:
                _startDate = new DateTime(now.Year, 1, 1);
                _endDate = _startDate.Value.AddYears(1).AddTicks(-1);
                _viewTitle = $"{now:yyyy年}";
                break;
        }
        await ApplyFilterAsync();
        await RenderChartAsync();
    }

    // 自定义筛选按钮的处理器
    private async Task ApplyCustomFilterAsync()
    {
        _currentViewMode = ViewMode.Custom;
        if (_startDate.HasValue && _endDate.HasValue)
        {
            _viewTitle = $"自定义范围: {_startDate:g} - {_endDate:g}";
        }
        else
        {
            _viewTitle = "自定义范围";
        }
        await ApplyFilterAsync();
        await RenderChartAsync();
    }

    // 通用的数据查询和UI刷新方法
    private async Task ApplyFilterAsync()
    {
        var query = DbContext.Sessions.AsQueryable();

        if (_startDate.HasValue)
        {
            // 支持时间段筛选
            query = query.Where(s => s.StartTime >= _startDate.Value);
        }
        if (_endDate.HasValue)
        {
            query = query.Where(s => s.EndTime <= _endDate.Value);
        }

        sessions = await query.ToListAsync();

        if (!sessions.Any())
        {
            message = "在指定的时间范围内没有找到任何记录。";
        }

        // 仅刷新C#部分的UI，图表渲染交由OnAfterRenderAsync
        StateHasChanged();
    }

    private async Task RenderChartAsync()
    {
        if (sessions == null || !sessions.Any())
        {
            await JSRuntime.InvokeVoidAsync("destroyChart", ChartCanvasId);
            return;
        }

        var categoryDistribution = sessions
            .Where(s => !string.IsNullOrEmpty(s.ActivityCategory) && s.ActualWorkDurationMinutes > 0)
            .GroupBy(s => s.ActivityCategory)
            .Select(g => new
            {
                Category = g.Key,
                TotalMinutes = g.Sum(s => s.ActualWorkDurationMinutes)
            })
            .ToList();

        if (categoryDistribution.Any())
        {
            var chartData = new
            {
                labels = categoryDistribution.Select(d => d.Category).ToArray(),
                values = categoryDistribution.Select(d => d.TotalMinutes).ToArray()
            };
            await JSRuntime.InvokeVoidAsync("createOrUpdatePieChart", ChartCanvasId, chartData);
        }
        else
        {
            await JSRuntime.InvokeVoidAsync("destroyChart", ChartCanvasId);
        }
    }

    private void ShowConversationDetails(PomodoroSession session)
    {
        _selectedConversationJson = string.IsNullOrWhiteSpace(session.UserInput) ? "[]" : session.UserInput;
        _isHistoryModalVisible = true;
        StateHasChanged(); // 确保UI在非async方法中也能更新
    }

    public async ValueTask DisposeAsync()
    {
        await JSRuntime.InvokeVoidAsync("destroyChart", ChartCanvasId);
    }
}